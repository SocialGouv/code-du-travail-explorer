Plop:
  services:
    - name: $CI_REGISTRY_IMAGE/elasticsearch:$CI_COMMIT_TAG
      alias: elasticsearch
  variables:
    ELASTICSEARCH_URL: http://elasticsearch:$ELASTICSEARCH_PORT
    GIT_STRATEGY: none
  script:
    # NOTE(douglasduteil): the elasticsearch health check must be last
    # As we block the job waiting for elasticsearch to be up.
    - |-
      echo "connecting to $CI_REGISTRY_IMAGE/elasticsearch:$CI_COMMIT_TAG";
      echo $ELASTICSEARCH_URL;
      retry=180;
      while
        ! curl "$ELASTICSEARCH_URL/_cat/health?h=status" &&
        [[ $(( retry-- )) -gt 0 ]];
      do echo "Waiting for Elasticsearch to go Green ($retry)" ; sleep 1 ; done ;
      [ "$retry" -eq "-1" ] && exit 1
    #
