dist: trusty
sudo: false
language: generic
git:
  depth: 5

#

_before_install:
  - &install_latest_yarn
    - curl -o- -L https://yarnpkg.com/install.sh | bash -s -- --version 1.12.3
    - export PATH="$HOME/.yarn/bin:$PATH"
_environments:
  - &docker_image
    - REPO_SLUG=$(echo $TRAVIS_REPO_SLUG | tr A-Z a-z)
    - DOCKER_IMAGE="$(echo $REPO_SLUG | tr A-Z a-z):${TRAVIS_COMMIT:0:7}"
  - &docker-keys
    - secure: uH25+Py61ccMV/31sXamGEIHxZ35SBuMZrOzi5y6cn6bDA3pxxfgObnOjOs9+mOgB7XtBqpN/MUN6vBqrZ9L6jWFzgYafYVCxwYZzQyjJ/lIjoylnQrXEf2evP9VhGi5pcymfP7/eq+WTAGuMQVtwoFrhnX2cLpUcQQazhTiUORrjiyNcbIFcnudRGP/JWeByKQbiI07mLW3MNnMFTvfR1uyqWlsPBCQySaarBTenLcfjtnTRdMTkdXuHolXH+wRZ6R4l8gpP1X1Jr2NCc4Lt2WJlZRfSJs8fut6P3cm2fnexYued2SK7W38c+TL58fyVnzySWTmDCjjjA68SDzYZwHE+9YLL71L8EzvIfdkLNXH1o4FMJEEAsrUSGeE+lha/CcC/0AX+iBurepTVJjQlXggHRFdHQQtl2jT98gBJI/2W38o49d4t7NyzxpzRSXGhqAQzNjqh/Bysl3qb/29IJ/wWV6myLKGkapNZ8wQvMS7iNgJYmINpEAjv6bmqBRwAF9PiKy7QJrTV549YmFHYhzMsUbzgDxniGi2gNj60c1PnXBEoMwP3NtGXUhuKVpmiM5kPTz9PIqpYh4+3Bf3UjfFxu5KAcuDt670L0jjm29DXZ2MMveoBTbN3HV8e47JwjOCVPi6ZaR+AFIeBbb+B/8NT13Z00sBg/G1Wo/SkVM=
    - secure: vP7vkKB6mVuYLPDW3KqVFbXN9BHsBxAjyc+MaxDoC+z1z8Z3iNtw3tWv1TGq4rTTgLobvscwNJcQ0hK0keg2Ohbpr7Hvf4HpJb6I0/SDwEv9/1usOI86rq4MdWFXJMr/G7zJGKr2BNmzPQysPpo6HaCc7pYKp2aqp3wgIdEMQ7JtDqv11pu6hoxSqylmXHtOvqI0RbvIxRxhdGLTFCtSL5puZv3MiKGoGMOyZGRi+w/KUzsuNr0Tk6LhwNFDEUZ44TWz6TF6Mhq/F18/doBJ0m8DtY/jz3wsIg6wR+CLKaDtevYQaTphOOkoyoSwouw/A6C3DyfRx2rs4br/UHHh5feJi8NZxQEIhf67DRtUAX4d3/JQ+2uH/8vDgHPNjyIrSDr+sy3F5txaHV6RBApPe8DBFevkL719EtQj8WEFBVqKAOHLNsnDvj7KYX5ZG7TBu5R6kYrbBwsSZr49b0QJJpWCcuLqqMUDuX7zh41lQm7yWumInkFaTb/1qainiT3E+EPaYemQOoL6HgKutYIw0FyRUtH1+AWJYVFJvOzGUgTpjVj1pylPgK3RFMxCnoXnn/8fu8+ra2IBssjsTIpNPNz628oNOp9IM9ScFNW8RMa6rR3AblzWLA11zauD+FrqxjKZsQsUBXfJH2qTetOd5/L6wtjbZBxGbT9RIfnOC0s=

#

jobs:
  include:
    - stage: Prepare
      name: Build and deploy current commit docker image
      env: [*docker_image, *docker-keys]
      script:
        - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
        - docker build -t $DOCKER_IMAGE .
        - docker images
        - docker push $DOCKER_IMAGE

    #
    #
    #

    - stage: Code quality
      name: Lint @cdt/frontend
      env: [*docker_image]
      script: docker run $DOCKER_IMAGE yarn workspace @cdt/frontend lint
    - #
      name: Lint @cdt/api
      env: [*docker_image]
      script: docker run $DOCKER_IMAGE yarn workspace @cdt/api lint
    - #
      name: Lint @cdt/ui
      env: [*docker_image]
      script: docker run $DOCKER_IMAGE yarn workspace @cdt/ui lint
    - #
      name: Test @cdt/ui
      env: [*docker_image]
      script: docker run $DOCKER_IMAGE yarn workspace @cdt/ui test
      after_success: npx codecov
    - #
      name: Test @cdt/frontend
      env: [*docker_image]
      script: docker run $DOCKER_IMAGE yarn workspace @cdt/frontend test
      after_success: npx codecov
    - #
      name: Lint python code
      language: python
      python: 3.6
      env:
        - PIPENV_VENV_IN_PROJECT=1
        - PIPENV_IGNORE_VIRTUALENVS=1
      cache: pip
      before_install: cd packages/code-du-travail-data
      install:
        - pip install --upgrade pip
        - pip install pipenv --upgrade
        - pipenv install --dev --three
      script: pipenv run pylint search

notifications:
  slack:
    secure: P9HLRFvTGbMuevLDkTKPnoI9PG4HhIt50I6kX5RCzADQUBS2tBhT7ENYm3YaPvjZNcMvD4K5LcVAmpBoQxI3ccsm+KPpit/MX52I8G3JpI0uKO/8vS7hZRtzeyAiM1ZnruKU02bQqN05wNZIB0wD4kL1zYusa5i9+Nq7TtUf4EziOfqP4cTmz13yQ6DWzph/0/x+Qxbui6dm/oBifqMfOiXdkOVlNiarjeIpyN0JYkNlEzuXdiqMwAiojMgr2JhXYScwfJKWQSwD8sjndOSAoFwF6LBSto2rxInNAYZx/+9oqy0cxxrxMQv19xAhSGi425HT1clLHUsDJelGOQEi8Kktk13WKjTaeOSynsjfLicPLUA8N6g5s7osUUAd0Tm4EoyH7UnVA8dm43QvhwPIIAMC+xcFhKfvc6BeR3asY+Lwyr4Mi3WAy0NfW2vInqmpWHGQxZt/tku/pldD7gtlXbwyx5q0j3bDBmsXkwvtfIkZIzfh6uW/xKPzRxjXxo0K4gttd89N4VhKEDw/9hzEuKTNIb5Wcvlfg53giNW6EBQX8jZGe8Br+YflwNddv8okl7lQbAeZGFaCGAxPzEM4ggIHZ9oYxo+44b/my0oqzI7nCaMfj18BlHdyygHef6rTDaGTeLgFbcMLK0mimO5X5+kgM4UdZvRZtrmfMv6onwo=
