---
apiVersion: v1
kind: Pod
metadata:
  name: ${K8S_NAMESPACE}-${CONTEXT}-${BRANCH_HASH}
  labels:
    app: ${K8S_NAMESPACE}-${CONTEXT}-${BRANCH_HASH}
    git/branch: ${BRANCH_NAME}
    git/commit: ${COMMIT}
    gitlab/job: "${JOB_ID}"
spec:
  containers:
    - image: ${IMAGE_NAME}:${IMAGE_TAG}
      name: ${K8S_NAMESPACE}-${CONTEXT}
      env:
        - name: ELASTICSEARCH_URL
          value: "${CI_ELASTICSEARCH_CLUSTER}"
        - name: ELASTICSEARCH_USER
          valueFrom:
            secretKeyRef:
              name: elasticsearch-creds
              key: USERNAME
        - name: ELASTICSEARCH_PWD
          valueFrom:
            secretKeyRef:
              name: elasticsearch-creds
              key: PASSWORD
        - name: ES_INDEX_PREFIX
          value: "cdtn-${BRANCH_HASH}"
  restartPolicy: Never
  initContainers:
    - name: wait-for-elasticsearch
      image: alpine
      imagePullPolicy: Always
      env:
        - name: ELASTICSEARCH_URL
          value: "${CI_ELASTICSEARCH_CLUSTER}"
        - name: ELASTICSEARCH_USER
          valueFrom:
            secretKeyRef:
              name: elasticsearch-creds
              key: USERNAME
        - name: ELASTICSEARCH_PWD
          valueFrom:
            secretKeyRef:
              name: elasticsearch-creds
              key: PASSWORD
      command:
        - sh
        - -c
        - |
          apk add --no-cache curl=7.66.0-r0;
          sleep 10s # delay wait for elastic to be sure elastic had been removed first
          retry=120; # 5s * (12 * 10) = 10min
          while
            ! curl -sS --fail -u "${ELASTICSEARCH_USER}:${ELASTICSEARCH_PWD}:" "${CI_ELASTICSEARCH_CLUSTER}/_cat/health?h=status" &&
            [[ $(( retry-- )) -gt 0 ]];
          do echo "Waiting for Elasticsearch to go Green ($(( retry )))" ; sleep 5s ; done ;

          [[ $(( retry )) -lt 1 ]] && exit 128;

          echo Ready;
