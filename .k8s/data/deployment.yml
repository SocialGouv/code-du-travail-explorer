---
apiVersion: v1
kind: Pod
metadata:
  name: ${K8S_NAMESPACE}-${CONTEXT}-${BRANCH_HASH}
  labels:
    app: ${K8S_NAMESPACE}-${CONTEXT}-${BRANCH_HASH}
    git/branch: ${BRANCH_NAME}
  annotations:
    git/commit: ${COMMIT}
    gitlab/job: "${JOB_ID}"
spec:
  containers:
    - image: ${IMAGE_NAME}:${IMAGE_TAG}
      name: ${K8S_NAMESPACE}-${CONTEXT}
      env:
        - name: ELASTICSEARCH_URL
          value: "${CI_ELASTICSEARCH_CLUSTER}"
        - name: ELASTICSEARCH_USER
          valueFrom:
            secretKeyRef:
              name: elasticsearch-creds
              key: user
        - name: ELASTICSEARCH_PWD
          valueFrom:
            secretKeyRef:
              name: elasticsearch-creds
              key: password
        - name: ES_INDEX_PREFIX
          value: "cdtn-${BRANCH_HASH}"
  restartPolicy: Never
  initContainers:
    - name: wait-for-elasticsearch
      image: curlimages/curl:7.67.0
      imagePullPolicy: Always
      env:
        - name: CI_ELASTICSEARCH_CLUSTER
          value: "${CI_ELASTICSEARCH_CLUSTER}"
        - name: ELASTICSEARCH_USER
          valueFrom:
            secretKeyRef:
              name: elasticsearch-creds
              key: user
        - name: ELASTICSEARCH_PWD
          valueFrom:
            secretKeyRef:
              name: elasticsearch-creds
              key: password
      command:
        - sh
        - -c
        - |
          retry=120; # 5s * (12 * 10) = 10min
          while
            ! curl -sS --fail -u $ELASTICSEARCH_USER:$ELASTICSEARCH_PWD "${CI_ELASTICSEARCH_CLUSTER}/_cat/health?h=status" &&
            [[ $(( retry-- )) -gt 0 ]];
          do echo "Waiting for Elasticsearch to go Green ($(( retry )))" ; sleep 5s ; done ;

          [[ $(( retry )) -lt 1 ]] && exit 128;

          echo Ready;
