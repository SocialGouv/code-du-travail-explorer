#

include:
  - project: SocialGouv/gitlab-ci-yml
    file: /base_semantic_release_stage.yml
    ref: v3.1.0
  - project: SocialGouv/gitlab-ci-yml
    file: /base_notify_github_stage.yml
    ref: master

#

Notify Starting Deployment:
  extends: .base_notify_pending_stage
  stage: Deploy

Notify Fail:
  extends: .base_notify_fail_stage
  stage: Notify Finished Deployment
  dependencies:
    - Notify Starting Deployment

Notify Success:
  extends: .base_notify_success_stage
  stage: Notify Finished Deployment
  dependencies:
    - Notify Starting Deployment

#
#
#

Release:
  stage: "Deploy"
  image: node:10.17.0-alpine3.10
  dependencies: []
  only:
    - branches
  when: manual
  before_script:
    - apk add --no-cache git=~2
    - git checkout ${CI_COMMIT_REF_NAME}
    - git config user.name "${CI_GIT_AUTHOR_NAME}"
    - git config user.email "${CI_GIT_AUTHOR_EMAIL}"
    - git remote set-url origin https://${GITHUB_TOKEN}@github.com/${CI_PROJECT_PATH}.git
    - yarn --frozen-lockfile
  script:
    - GH_TOKEN=${GITHUB_TOKEN} yarn lerna version ${LERNA_ARGS:="--force-publish --yes"}

#
#
#

Production:
  stage: "Deploy"
  image: curlimages/curl:7.67.0
  dependencies: []
  when: manual
  only:
    - branches
  except:
    variables:
      - $PRODUCTION
  script:
    - echo "Put ${CI_COMMIT_REF_NAME}@${CI_COMMIT_SHORT_SHA} in production"
    - echo "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/trigger/pipeline"
    # - curl --request POST
    #   --form ref="${CI_COMMIT_REF_NAME}"
    #   --form token="${CI_DEPLOY_TRIGGER}"
    #   --form variables[PRODUCTION]="true"
    #   ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/trigger/pipeline
